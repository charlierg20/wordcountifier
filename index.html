<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Wordcountifier</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous"
    />

    <!-- Google Fonts (fixed link) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Tinos:ital,wght@0,400;0,700;1,400;1,700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        text-align: center;
        padding: 40px;
        font-family: "Tinos", serif;
        font-weight: 400;
        font-style: normal;
      }
      .counter-card { max-width: 780px; margin: 16px auto 0; text-align: left; }
      .editor-wrap { max-width: 780px; margin: 0 auto; }
      textarea { font-size: 1.05rem; }
      .small-hint { font-size: 0.875rem; opacity: 0.8; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    </style>
  </head>
  <body>
    <h1><b>Wordcountifier</b></h1>
    <p>Find word counts instantly</p>

    <div class="editor-wrap">
      <div class="form-check form-switch text-start mb-3">
        <input class="form-check-input" type="checkbox" role="switch" id="includeRefs" />
        <label class="form-check-label" for="includeRefs">Include in‑text references (parenthetical citations) in the word count</label>
      </div>

      <div class="d-flex gap-2 mb-2">
        <button id="pasteBtn" type="button" class="btn btn-primary">Paste from clipboard</button>
        <button id="clearBtn" type="button" class="btn btn-outline-secondary">Clear</button>
        <span id="status" class="align-self-center small text-muted"></span>
      </div>

      <textarea id="inputText" class="form-control" rows="10" placeholder="Paste or type your text here…"></textarea>

      <div class="card counter-card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-3">Word count</h5>
          <div class="row g-3">
            <div class="col-12 col-md-4">
              <div class="border rounded p-3 h-100">
                <div class="small text-muted">Total words (raw)</div>
                <div class="fs-3 fw-bold" id="rawCount">0</div>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="border rounded p-3 h-100">
                <div class="small text-muted">Words <span id="modeLabel">excluding</span> references</div>
                <div class="fs-3 fw-bold" id="finalCount">0</div>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="border rounded p-3 h-100">
                <div class="small text-muted">References detected</div>
                <div class="fs-3 fw-bold" id="refCount">0</div>
              </div>
            </div>
          </div>
          <p class="mt-3 mb-0 small-hint">
            A reference is detected when it looks like <span class="mono">(Author, 1999)</span>,
            <span class="mono">(Author and Smith, 1841)</span>, <span class="mono">(Author et al, 2012)</span>,
            or multiple separated by semicolons like <span class="mono">(Author, 1924; Smith, 2953)</span>.
          </p>
        </div>
      </div>
    </div>

    <br>

    <p>By Charlie Grivell. &copy; 2025 All rights reserved</p>

    <script>
      (function () {
        // --- Reference detection (ASCII-safe) ---
        // Matches (...) that contain a year (3–5 digits, optional trailing letter), supports semicolons.
        var REF = '\\((?:[^)]*\\d{3,5}[a-z]?)(?:\\s*;\\s*[^)]*\\d{3,5}[a-z]?)*\\s*\\)';
        var referenceRegex = new RegExp(REF, 'g');

        // --- Word tokenizer (ASCII-safe) ---
        // 1) Dotted abbreviations like U.S. / U.K., allowing missing final dot before possessive: U.S’
        // 2) Slashed forms like 9/11 or 2024/25
        // 3) Standard words with internal apostrophes/hyphens
        // Accept apostrophe variants: ' \u2019 (curly) \u2032 (prime)
        var APOST = "[\\'\\u2019\\u2032]";
        var ABBREV = '(?:(?:[A-Za-z]\\.){2,}|(?:[A-Za-z]\\.){1,}[A-Za-z])(?:' + APOST + '(?:s)?)?';
        // AFTER (supports accents like ö, ñ, é, etc., and NB hyphen/en dash)
        var SLASHED = '[A-Za-z\\u00C0-\\u024F0-9]+(?:\\/[A-Za-z\\u00C0-\\u024F0-9]+)+';
        var STANDARD = '(?:[A-Za-z\\u00C0-\\u024F0-9]+(?:' + APOST + '|[-\\u2011\\u2013])[A-Za-z\\u00C0-\\u024F0-9]+|[A-Za-z\\u00C0-\\u024F0-9]+)';
        var WORD_RE = new RegExp('(?:' + ABBREV + '|' + SLASHED + '|' + STANDARD + ')', 'g');

        function tokenizeWords(text) {
          var matches = text.match(WORD_RE);
          return matches ? matches.length : 0;
        }

        function countReferences(text) {
          var refs = text.match(referenceRegex) || [];
          return { groups: refs.length, snippets: refs };
        }

        // --- DOM wiring ---
        var input = document.getElementById('inputText');
        var includeRefs = document.getElementById('includeRefs');
        var rawCountEl = document.getElementById('rawCount');
        var finalCountEl = document.getElementById('finalCount');
        var refCountEl = document.getElementById('refCount');
        var modeLabel = document.getElementById('modeLabel');
        var pasteBtn = document.getElementById('pasteBtn');
        var clearBtn = document.getElementById('clearBtn');
        var statusEl = document.getElementById('status');

        function setStatus(msg, ok) {
          statusEl.textContent = msg || '';
          statusEl.className = 'align-self-center small ' + (ok ? 'text-success' : 'text-muted');
        }

        function updateCounts() {
          var text = input.value || '';
          var raw = tokenizeWords(text);
          var refs = countReferences(text);
          rawCountEl.textContent = raw;
          refCountEl.textContent = refs.groups;

          var include = includeRefs.checked;
          modeLabel.textContent = include ? 'including' : 'excluding';

          var final = raw;
          if (!include && refs.groups > 0) {
            var withoutRefs = text.replace(referenceRegex, ' ');
            final = tokenizeWords(withoutRefs);
          }
          finalCountEl.textContent = final;
        }

        includeRefs.addEventListener('change', updateCounts);
        input.addEventListener('input', updateCounts);

        clearBtn.addEventListener('click', function () {
          input.value = '';
          updateCounts();
          setStatus('Cleared.', true);
          input.focus();
        });

        pasteBtn.addEventListener('click', async function () {
          try {
            if (!navigator.clipboard || !navigator.clipboard.readText) {
              setStatus('Clipboard API not available. Use Ctrl/Cmd+V instead.', false);
              input.focus();
              return;
            }
            const text = await navigator.clipboard.readText();
            if (!text) {
              setStatus('Clipboard is empty.', false);
              input.focus();
              return;
            }
            input.value = text;
            updateCounts();
            setStatus('Pasted from clipboard.', true);
            input.focus();
          } catch (err) {
            setStatus('Cannot read clipboard (browser permission / HTTPS required). Use Ctrl/Cmd+V.', false);
            input.focus();
          }
        });

        // Initial draw
        updateCounts();
      })();
    </script>
  </body>
</html>
